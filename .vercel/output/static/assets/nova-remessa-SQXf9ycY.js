import{r as n,s as F,u as V,j as e,Q as K,a7 as H,a8 as Y,a9 as x,aa as y,ab as q,ac as O,B as z,k as v,l as p,m as G,n as u,T as B,ai as Q,au as D,ar as _,av as J,D as W,E as X,F as Z,G as U}from"./index-bemzWiEF.js";import{u as ee,f as N,g as ae,a as se,b as oe,c as te}from"./index-COrdChp8.js";import{T as ce,a as re,b as f,c as ne,d as le,e as L}from"./table-Bs0-gs75.js";import{C as T}from"./checkbox-CaehKnLF.js";import{E as ie,a as de}from"./jspdf.plugin.autotable-B6PkcRol.js";import"./check-BQ99PCGz.js";const fe=()=>{var w;const[R,P]=n.useState([]),[g,m]=n.useState(!0),[h,M]=n.useState([]),[b,I]=n.useState({}),j=F(),{currentUser:t}=V();n.useEffect(()=>{t.isClient&&j("/"),(async()=>{m(!0);try{const s=v(p,"cheques"),r=(await G(s)).docs.map(c=>({...c.data(),id:c.id})).filter(c=>c.local==="Escritório");P(r)}catch(s){console.error("Erro ao buscar cheques:",s),u.error("Ocorreu um erro ao buscar os cheques.")}finally{m(!1)}})()},[]);const S=[{id:"select",header:({table:a})=>e.jsx(T,{checked:a.getIsAllPageRowsSelected(),onCheckedChange:s=>a.toggleAllPageRowsSelected(!!s),"aria-label":"Selecionar todos"}),cell:({row:a})=>e.jsx(T,{checked:a.getIsSelected(),onCheckedChange:s=>a.toggleSelected(!!s),"aria-label":"Selecionar linha"}),enableSorting:!1,enableHiding:!1},{accessorKey:"numeroCheque",header:"Número do Cheque"},{accessorKey:"banco",header:"Banco"},{accessorKey:"vencimento",header:"Vencimento",cell:({row:a})=>{const s=a.getValue("vencimento");return new Date(s).toLocaleDateString("pt-BR")}},{accessorKey:"nome",header:"Nome"},{accessorKey:"valor",header:()=>e.jsx("div",{className:"text-right",children:"Valor"}),cell:({row:a})=>{const o=a.getValue("valor").toLocaleString("pt-BR",{style:"currency",currency:"BRL"});return e.jsx("div",{className:"text-right font-medium",children:o})}}],l=ee({data:R,columns:S,state:{rowSelection:b},onRowSelectionChange:I,getCoreRowModel:ae(),getSortedRowModel:se(),getFilteredRowModel:oe(),getPaginationRowModel:te()});n.useEffect(()=>{const a=l.getSelectedRowModel().rows.map(s=>s.original);M(a)},[b,l]);const E=()=>{const a=new Date().toLocaleDateString("pt-BR").replace(/\//g,""),s=Math.floor(1e3+Math.random()*9e3).toString();return`${a}${s}`},k=async(a,s)=>{const o=new ie;o.setFontSize(18),o.text("Remessa de Cheques",14,22),o.setFontSize(12),o.text(`Protocolo: ${a.protocolo}`,14,32),o.text(`Data da Remessa: ${new Date(a.dataRemessa).toLocaleDateString("pt-BR")}`,14,38),o.text(`Emitido por: ${a.emitidoPor}`,14,44);const r=a.cheques.map((d,A)=>[A+1,d.numeroCheque,d.banco,new Date(d.vencimento).toLocaleDateString("pt-BR"),d.nome,d.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})]);de(o,{startY:50,head:[["#","Número do Cheque","Banco","Vencimento","Nome","Valor"]],body:r}),o.text("Assinatura de Recebimento:",14,o.lastAutoTable.finalY+30),o.line(14,o.lastAutoTable.finalY+45,196,o.lastAutoTable.finalY+45);const c=o.output("blob"),i=W(X,`remessas/${s}/Remessa_${a.protocolo}.pdf`);return await Z(i,c),await U(i)},$=async()=>{if(m(!0),h.length===0){u.error("Selecione pelo menos um cheque para iniciar a remessa.");return}try{const a=E(),s=v(p,"remessas"),o={protocolo:a,dataRemessa:new Date().toISOString(),emitidoPor:t==null?void 0:t.displayName,cheques:h,status:"Transporte",log:[{timestamp:B.now(),message:"Remessa criada",user:(t==null?void 0:t.displayName)||(t==null?void 0:t.email)||"Usuário desconhecido"}]},r=await Q(s,o),c=await k(o,r.id);await D(r,{documentoPdfUrl:c});for(const i of h){const C=_(p,"cheques",i.id);await D(C,{local:"Transporte",remessaId:r.id,log:J({timestamp:B.now(),message:`Cheque incluído na remessa ${o.protocolo}`,user:(t==null?void 0:t.displayName)||(t==null?void 0:t.email)||"Usuário desconhecido"})})}u.success("Remessa iniciada com sucesso!"),j("/remessas")}catch(a){console.error("Erro ao iniciar remessa:",a),u.error("Ocorreu um erro ao iniciar a remessa.")}finally{m(!1)}};return e.jsxs("div",{className:"w-full min-h-screen p-4 space-y-6",children:[e.jsx(K,{}),e.jsx(H,{children:e.jsxs(Y,{children:[e.jsx(x,{children:e.jsx(y,{href:"/",children:"Dashboard"})}),e.jsx(q,{}),e.jsx(x,{children:e.jsx(y,{href:"/remessas",children:"Lista de Remessas"})}),e.jsx(q,{}),e.jsx(x,{children:e.jsx(O,{children:"Nova Remessa"})})]})}),e.jsx("div",{className:"flex justify-between items-center",children:e.jsx("h1",{className:"text-2xl font-bold ",children:"Iniciar Nova Remessa"})}),g?e.jsx("p",{children:"Carregando..."}):e.jsx(e.Fragment,{children:R.length===0?e.jsx("p",{children:"Nenhum cheque disponível no escritório."}):e.jsxs("div",{children:[e.jsx("div",{className:"rounded-md border",children:e.jsxs(ce,{children:[e.jsx(re,{children:l.getHeaderGroups().map(a=>e.jsx(f,{children:a.headers.map(s=>e.jsx(ne,{children:s.isPlaceholder?null:N(s.column.columnDef.header,s.getContext())},s.id))},a.id))}),e.jsx(le,{children:(w=l.getRowModel().rows)!=null&&w.length?l.getRowModel().rows.map(a=>e.jsx(f,{"data-state":a.getIsSelected()&&"selected",onClick:()=>a.toggleSelected(),className:a.getIsSelected()?"bg-gray-100":"",children:a.getVisibleCells().map(s=>e.jsx(L,{children:N(s.column.columnDef.cell,s.getContext())},s.id))},a.id)):e.jsx(f,{children:e.jsx(L,{colSpan:S.length,className:"h-24 text-center",children:"Nenhum cheque encontrado."})})})]})}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx(z,{onClick:$,disabled:g,children:g?"Iniciando...":`Iniciar Remessa com ${h.length} Cheque(s)`})})]})})]})};export{fe as default};

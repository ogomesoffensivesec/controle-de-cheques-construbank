import{aj as W,r as h,s as X,u as Y,j as e,Q as Z,a7 as ee,a8 as ae,a9 as q,aa as I,ab as O,ac as se,ak as oe,al as re,B as g,am as te,an as le,ao as ie,ap as ne,L as i,I as n,ae as ce,af as de,ag as ue,ah as me,ad as he,C as xe,i as pe,aq as je,k as fe,l as x,m as ge,n as p,ar as j,as as ve,D as C,E as N,at as z,au as qe,av as Ce,T as y,aw as E,ax as Ne,F as ye,G as Re}from"./index-CLtyk14W.js";import{S as B}from"./scroll-area-DEKxqJx0.js";import{S as U,a as A,b as T,c as P,d as De,e as V}from"./cheques--DLE8VzO.js";import{k as be}from"./format-CphUbbWy.js";import"./index-BFRFAaAD.js";import"./check-D-40C26n.js";const ze=()=>{const{id:m}=W(),[k,$]=h.useState([]),v=X(),[a,R]=h.useState(null),[M,D]=h.useState(!0),[b,w]=h.useState(!1),[F,S]=h.useState(!1),[H,L]=h.useState(!1),{currentUser:r}=Y();h.useEffect(()=>{r.isClient&&v("/"),(async()=>{try{const o=fe(x,"clientes"),d=await(await ge(o)).docs.map(c=>({id:c.id,...c.data()}));$(d)}catch(o){console.error("Erro ao buscar cheques:",o),p.error("Ocorreu um erro ao buscar os cheques.")}})()},[]),h.useEffect(()=>{(async()=>{if(m){D(!0);try{const o=j(x,"cheques",m),t=await ve(o);if(t.exists()){const d=t.data();R({...d,id:m,regiao:d.regiao||"Não definido"})}else p.error("Cheque não encontrado.")}catch(o){console.error("Erro ao buscar cheque:",o),p.error("Ocorreu um erro ao buscar o cheque.")}finally{D(!1)}}})()},[m]);const l=(s,o)=>{a&&R(t=>t&&{...t,[s]:o})},J=async s=>{if(!a)return"";const o=C(N,`cheques/anexos/${m}/${s.name}`),t=await ye(o,s);return await Re(t.ref)},Q=async()=>{if(!a){console.log("Nenhum cheque fornecido.");return}w(!0),console.log("Iniciando atualização do cheque...",{cheque:a});try{let s=a.anexoUrl;if(console.log("URL inicial do anexo:",s),a.anexoFile){if(console.log("Novo arquivo de anexo detectado:",a.anexoFile),a.anexoUrl){console.log("Deletando anexo anterior:",a.anexoUrl);const t=C(N,a.anexoUrl);await z(t),console.log("Anexo anterior deletado com sucesso.")}s=await J(a.anexoFile),console.log("Novo anexo carregado com sucesso:",s)}const o=j(x,"cheques",m);if(console.log("Atualizando cheque no Firestore:",{...a,anexoUrl:s}),await qe(o,{leitora:a.leitora,numeroCheque:a.numeroCheque,nome:a.nome,cpf:a.cpf,valor:a.valor,motivoDevolucao:a.motivoDevolucao,numeroOperacao:a.numeroOperacao,anexoUrl:s,clientId:a.clientId,quemRetirou:a.quemRetirou,dataRetirada:a.dataRetirada,regiao:a.regiao,log:Ce({timestamp:y.now(),message:"Cheque atualizado",user:(r==null?void 0:r.displayName)||(r==null?void 0:r.email)||"Usuário desconhecido"})}),console.log("Cheque atualizado com sucesso no Firestore."),a.remessaId){console.log("Cheque associado a uma remessa. ID da remessa:",a.remessaId);const t=j(x,"remessas",a.remessaId);await E(x,async d=>{const c=await d.get(t);if(!c.exists())throw new Error("Remessa não encontrada.");const u=c.data();console.log("Dados da remessa antes da atualização:",u);const f=u.cheques.findIndex(K=>K.id===m);if(f===-1)throw new Error("Cheque não encontrado na remessa.");u.cheques[f]={...u.cheques[f],leitora:a.leitora,numeroCheque:a.numeroCheque,nome:a.nome,cpf:a.cpf,valor:a.valor,motivoDevolucao:a.motivoDevolucao,numeroOperacao:a.numeroOperacao,anexoUrl:a.anexoUrl,quemRetirou:a.quemRetirou,dataRetirada:a.dataRetirada,regiao:a.regiao},console.log("Cheque atualizado dentro da remessa:",u.cheques[f]),u.log||(u.log=[]),u.log.push({timestamp:y.now(),message:`Cheque ${a.numeroCheque} atualizado`,user:(r==null?void 0:r.displayName)||(r==null?void 0:r.email)||"Usuário desconhecido"}),d.update(t,u),console.log("Remessa atualizada com sucesso no Firestore.")})}p.success("Cheque atualizado com sucesso!"),L(!1),console.log("Processo concluído com sucesso.")}catch(s){console.error("Erro ao atualizar cheque:",s),p.error(s.message||"Ocorreu um erro ao atualizar o cheque.")}finally{console.log("Finalizando processo de atualização."),w(!1)}},_=async()=>{if(a&&window.confirm("Tem certeza de que deseja excluir este cheque?")){S(!0);try{if(a.anexoUrl){const o=C(N,a.anexoUrl);await z(o)}const s=j(x,"cheques",m);if(await Ne(s),a.remessaId){const o=j(x,"remessas",a.remessaId);await E(x,async t=>{const d=await t.get(o);if(!d.exists()){alert("Remessa não encontrada."),v("/cheques");return}const c=d.data();c.cheques=c.cheques.filter(u=>u.id!==m),c.log||(c.log=[]),c.log.push({timestamp:y.now(),message:`Cheque ${a.numeroCheque} excluído`,user:(r==null?void 0:r.displayName)||(r==null?void 0:r.email)||"Usuário desconhecido"}),t.update(o,c)})}p.success("Cheque excluído com sucesso!"),v("/cheques")}catch(s){console.error("Erro ao excluir cheque:",s),p.error(s.message||"Ocorreu um erro ao excluir o cheque.")}finally{S(!1)}}},G=s=>{const o=s.target.value.replace(/\D/g,""),t=o.slice(12,17);l("numeroCheque",t),l("leitora",o)};return e.jsxs("div",{className:"w-full min-h-screen p-4 space-y-6",children:[e.jsx(Z,{}),M?e.jsx("p",{children:"Carregando..."}):a?e.jsxs("div",{children:[e.jsx(ee,{className:"mb-4",children:e.jsxs(ae,{children:[e.jsx(q,{children:e.jsx(I,{href:"/",children:"Dashboard"})}),e.jsx(O,{}),e.jsx(q,{children:e.jsx(I,{href:"/cheques",children:"Lista de cheques"})}),e.jsx(O,{}),e.jsx(q,{children:e.jsxs(se,{children:["Detalhes do cheque: ",a.numeroCheque]})})]})}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h1",{className:"text-2xl font-bold mb-4 text-zinc-800 dark:text-white",children:["Detalhes do Cheque: ",a.numeroCheque]}),e.jsx("div",{className:"flex space-x-2",children:e.jsxs(oe,{open:H,onOpenChange:L,children:[e.jsx(re,{asChild:!0,children:e.jsx(g,{children:"Editar Cheque"})}),e.jsxs(te,{side:"top",className:"p-4",children:[e.jsxs(le,{children:[e.jsx(ie,{children:"Editar Cheque"}),e.jsx(ne,{children:"Atualize as informações do cheque conforme necessário."})]}),e.jsx(B,{className:"h-[70vh]",children:e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsxs("div",{children:[e.jsx(i,{htmlFor:"leitora",children:"Leitora *"}),e.jsx(n,{type:"text",id:"leitora",value:a.leitora,onChange:s=>G(s),placeholder:"Leitora"})]}),e.jsxs("div",{children:[e.jsx(i,{htmlFor:"numeroCheque",children:"Número do Cheque *"}),e.jsx(n,{type:"text",id:"numeroCheque",value:a.numeroCheque,onChange:s=>l("numeroCheque",s.target.value),placeholder:"Número do Cheque"})]}),e.jsxs("div",{children:[e.jsx(i,{htmlFor:"nome",children:"Nome *"}),e.jsx(n,{type:"text",id:"nome",value:a.nome,onChange:s=>{s.target.value=s.target.value.toUpperCase(),l("nome",s.target.value)},placeholder:"Nome"})]}),e.jsxs("div",{children:[e.jsx(i,{htmlFor:"cpf",children:"CPF/CNPJ *"}),e.jsx(n,{type:"text",id:"cpf",value:a.cpf,onChange:s=>l("cpf",s.target.value),placeholder:"CPF/CNPJ"})]}),e.jsxs("div",{children:[e.jsx(i,{htmlFor:"valor",children:"Valor *"}),e.jsx(n,{type:"number",id:"valor",value:a.valor,onChange:s=>l("valor",Number(s.target.value)),placeholder:"Valor"})]}),e.jsxs("div",{children:[e.jsx(i,{htmlFor:"motivoDevolucao",children:"Motivo da Devolução"}),e.jsxs(U,{value:a.motivoDevolucao,onValueChange:s=>l("motivoDevolucao",s),children:[e.jsx(A,{children:e.jsx(T,{placeholder:"Motivo da devolução"})}),e.jsx(P,{children:De.map(s=>e.jsx(V,{value:`${s.classificacao} - ${s.motivo}`,children:e.jsx(ce,{children:e.jsxs(de,{children:[e.jsx(ue,{asChild:!0,children:e.jsxs("span",{children:[s.classificacao," -  ",s.motivo]})}),s.descricao&&e.jsx(me,{children:s.descricao})]})})},s.classificacao))})]})]}),e.jsxs("div",{children:[e.jsx(i,{htmlFor:"numeroOperacao",children:"Número da Operação"}),e.jsx(n,{type:"text",id:"numeroOperacao",value:a.numeroOperacao,onChange:s=>l("numeroOperacao",s.target.value),placeholder:"Número da Operação"})]}),e.jsxs("div",{children:[e.jsx(i,{htmlFor:"banco",children:"Banco *"}),e.jsx(n,{type:"text",id:"banco",value:a.banco,onChange:s=>l("banco",s.target.value),placeholder:"Banco"})]}),e.jsxs("div",{children:[e.jsx(i,{htmlFor:"vencimento",children:"Vencimento do Cheque *"}),e.jsx(n,{type:"date",id:"vencimento",value:a.vencimento,onChange:s=>l("vencimento",s.target.value)})]}),e.jsxs("div",{children:[e.jsx(i,{htmlFor:"regiao",children:"Região *"}),e.jsx(n,{type:"text",id:"regiao",value:a.regiao,onChange:s=>l("regiao",s.target.value),placeholder:"Região"})]}),e.jsxs("div",{children:[e.jsx(i,{htmlFor:"local",children:"Local *"}),e.jsx(n,{type:"text",id:"local",value:a.local,onChange:s=>l("local",s.target.value),placeholder:"Local"})]}),e.jsxs("div",{children:[e.jsx(i,{htmlFor:"anexoFile",children:"Anexo do Cheque"}),e.jsx(n,{type:"file",id:"anexoFile",onChange:s=>l("anexoFile",s.target.files?s.target.files[0]:null),accept:".pdf, .jpg, .jpeg, .png"}),a.anexoUrl&&e.jsxs("p",{className:"mt-2",children:["Anexo atual:"," ",e.jsx("a",{href:a.anexoUrl,target:"_blank",rel:"noopener noreferrer",className:"text-blue-500 underline",children:"Visualizar"})]})]}),e.jsxs("div",{children:[e.jsx(i,{htmlFor:"quemRetirou",children:"Quem Retirou *"}),e.jsx(n,{type:"text",id:"quemRetirou",value:a.quemRetirou,onChange:s=>l("quemRetirou",s.target.value),placeholder:"Nome do responsável"})]}),e.jsxs("div",{children:[e.jsx(i,{htmlFor:"dataRetirada",children:"Data da Retirada *"}),e.jsx(n,{type:"date",id:"dataRetirada",value:a.dataRetirada,onChange:s=>l("dataRetirada",s.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(i,{htmlFor:"clientId",children:"Cliente *"}),e.jsxs(U,{onValueChange:s=>l("clientId",s),children:[e.jsx(A,{children:e.jsx(T,{placeholder:"Selecione o cliente"})}),e.jsx(P,{children:k.map(s=>e.jsx(V,{value:s.id,children:s.nome},s.id))})]})]}),e.jsxs("div",{className:"flex justify-end space-x-2 mt-4",children:[e.jsxs(g,{variant:"destructive",onClick:_,disabled:F,children:[F?"Excluindo...":"Excluir Cheque",e.jsx(he,{className:"w-4 h-4 ml-2"})]}),e.jsx(g,{onClick:Q,disabled:b,children:b?"Atualizando...":"Salvar Alterações"})]})]})})]})]})})]}),e.jsx(xe,{className:"w-full",children:e.jsxs(pe,{className:"px-6 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Leitora"}),e.jsx("p",{className:"font-medium",children:a.leitora})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Número do Cheque"}),e.jsx("p",{className:"font-medium",children:a.numeroCheque})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Nome"}),e.jsx("p",{className:"font-medium",children:a.nome})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"CPF/CNPJ"}),e.jsx("p",{className:"font-medium",children:a.cpf})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Valor"}),e.jsx("p",{className:"font-medium",children:a.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Motivo da Devolução"}),e.jsx("p",{className:"font-medium",children:a.motivoDevolucao})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Número da Operação"}),e.jsx("p",{className:"font-medium",children:a.numeroOperacao})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Quem Retirou"}),e.jsx("p",{className:"font-medium",children:a.quemRetirou})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Data da Retirada"}),e.jsx("p",{className:"font-medium",children:a.dataRetirada})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Local"}),e.jsx("p",{className:"font-medium",children:a.local})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Região"}),e.jsx("p",{className:"font-medium",children:a.regiao||"Não definido"})]})]}),a.anexoUrl&&e.jsx("div",{className:"mt-6",children:e.jsx(g,{variant:"outline",className:"w-full",children:e.jsxs("a",{href:a.anexoUrl,className:"w-full flex justify-center gap-2 items-center",target:"_blank",rel:"noopener noreferrer",children:[e.jsx(je,{className:"h-4 w-4"}),"Visualizar Anexo"]})})})]})}),e.jsxs("div",{className:"mt-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Log de Atividades"}),a.log&&a.log.length>0?e.jsx(B,{className:"space-y-4 h-[300px]",children:a.log.sort((s,o)=>o.timestamp.seconds-s.timestamp.seconds).map((s,o)=>e.jsxs("div",{className:"w-full border-b p-2",children:[e.jsxs("p",{className:"text-xs text-gray-500 ",children:["Por ",s.user," às ",be(s.timestamp.toDate(),"dd/MM/yyyy HH:mm:ss")]}),e.jsx("p",{children:s.message})]},o))}):e.jsx("p",{children:"Nenhuma atividade registrada."})]})]}):e.jsx("p",{children:"Cheque não encontrado."})]})};export{ze as default};

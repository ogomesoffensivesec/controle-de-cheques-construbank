import{r as d,j as e,H as u,J as O,K as _,s as J,u as Q,Q as W,a7 as X,a8 as Z,a9 as w,aa as q,ab as B,ac as U,B as ee,k as D,l as C,m as ae,n as f,T as L,ai as se,au as T,ar as oe,av as te,D as ne,E as re,F as ce,G as le}from"./index-CLtyk14W.js";import{u as ie,f as k,g as de,a as me,b as he,c as ue}from"./index-DvTMkO70.js";import{T as ge,a as xe,b as y,c as pe,d as fe,e as I}from"./table-C9yEHQlt.js";import{C as M}from"./checkbox-B_x3_b7U.js";import{C as je,E as Re,a as be}from"./jspdf.plugin.autotable-DCSQAH1T.js";import"./check-D-40C26n.js";const E=({className:n,...r})=>e.jsx("nav",{role:"navigation","aria-label":"pagination",className:u("mx-auto flex w-full justify-center",n),...r});E.displayName="Pagination";const $=d.forwardRef(({className:n,...r},c)=>e.jsx("ul",{ref:c,className:u("flex flex-row items-center gap-1",n),...r}));$.displayName="PaginationContent";const j=d.forwardRef(({className:n,...r},c)=>e.jsx("li",{ref:c,className:u("",n),...r}));j.displayName="PaginationItem";const R=({className:n,isActive:r,size:c="icon",...m})=>e.jsx("a",{"aria-current":r?"page":void 0,className:u(O({variant:r?"outline":"ghost",size:c}),n),...m});R.displayName="PaginationLink";const A=({className:n,...r})=>e.jsxs(R,{"aria-label":"Go to previous page",size:"default",className:u("gap-1 pl-2.5",n),...r,children:[e.jsx(je,{className:"h-4 w-4"}),e.jsx("span",{children:"Anterior"})]});A.displayName="PaginationPrevious";const V=({className:n,...r})=>e.jsxs(R,{"aria-label":"Go to next page",size:"default",className:u("gap-1 pr-2.5",n),...r,children:[e.jsx("span",{children:"Próximo"}),e.jsx(_,{className:"h-4 w-4"})]});V.displayName="PaginationNext";const ve=()=>{var P;const[n,r]=d.useState([]),[c,m]=d.useState(!0),[p,F]=d.useState([]),[N,K]=d.useState({}),b=J(),{currentUser:t}=Q();d.useEffect(()=>{t.isClient&&b("/"),(async()=>{m(!0);try{const s=D(C,"cheques"),h=(await ae(s)).docs.map(i=>({...i.data(),id:i.id})).filter(i=>i.local==="Escritório");r(h)}catch(s){console.error("Erro ao buscar cheques:",s),f.error("Ocorreu um erro ao buscar os cheques.")}finally{m(!1)}})()},[t,b]);const S=[{id:"select",header:({table:a})=>e.jsx(M,{checked:a.getIsAllPageRowsSelected(),onCheckedChange:s=>a.toggleAllPageRowsSelected(!!s),"aria-label":"Selecionar todos"}),cell:({row:a})=>e.jsx(M,{checked:a.getIsSelected(),onCheckedChange:s=>a.toggleSelected(!!s),"aria-label":"Selecionar linha"}),enableSorting:!1,enableHiding:!1},{accessorKey:"numeroCheque",header:"Número do Cheque"},{accessorKey:"banco",header:"Banco"},{accessorKey:"vencimento",header:"Vencimento",cell:({row:a})=>{const s=a.getValue("vencimento");return new Date(s).toLocaleDateString("pt-BR")}},{accessorKey:"nome",header:"Nome"},{accessorKey:"valor",header:()=>e.jsx("div",{className:"text-right",children:"Valor"}),cell:({row:a})=>{const o=a.getValue("valor").toLocaleString("pt-BR",{style:"currency",currency:"BRL"});return e.jsx("div",{className:"text-right font-medium",children:o})}}],l=ie({data:n,columns:S,state:{rowSelection:N},onRowSelectionChange:K,getCoreRowModel:de(),getSortedRowModel:me(),getFilteredRowModel:he(),getPaginationRowModel:ue()});d.useEffect(()=>{const a=l.getSelectedRowModel().rows.map(s=>s.original);F(a)},[N,l]);const H=()=>{const a=new Date().toLocaleDateString("pt-BR").replace(/\//g,""),s=Math.floor(1e3+Math.random()*9e3).toString();return`${a}${s}`},z=async(a,s)=>{const o=new Re;o.setFontSize(18),o.text("Remessa de Cheques",14,22),o.setFontSize(12),o.text(`Protocolo: ${a.protocolo}`,14,32),o.text(`Data da Remessa: ${new Date(a.dataRemessa).toLocaleDateString("pt-BR")}`,14,38),o.text(`Emitido por: ${a.emitidoPor}`,14,44);const h=a.cheques.map((x,G)=>[G+1,x.numeroCheque,x.banco,new Date(x.vencimento).toLocaleDateString("pt-BR"),x.nome,x.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})]);be(o,{startY:50,head:[["#","Número do Cheque","Banco","Vencimento","Nome","Valor"]],body:h}),o.text("Assinatura de Recebimento:",14,o.lastAutoTable.finalY+30),o.line(14,o.lastAutoTable.finalY+45,196,o.lastAutoTable.finalY+45);const i=o.output("blob"),g=ne(re,`remessas/${s}/Remessa_${a.protocolo}.pdf`);return await ce(g,i),await le(g)},Y=async()=>{if(m(!0),p.length===0){f.error("Selecione pelo menos um cheque para iniciar a remessa."),m(!1);return}try{const a=H(),s=D(C,"remessas"),o={protocolo:a,dataRemessa:new Date().toISOString(),emitidoPor:t==null?void 0:t.displayName,cheques:p,status:"Transporte",log:[{timestamp:L.now(),message:"Remessa criada",user:(t==null?void 0:t.displayName)||(t==null?void 0:t.email)||"Usuário desconhecido"}]},h=await se(s,o),i=await z(o,h.id);await T(h,{documentoPdfUrl:i});for(const g of p){const v=oe(C,"cheques",g.id);await T(v,{local:"Transporte",remessaId:h.id,log:te({timestamp:L.now(),message:`Cheque incluído na remessa ${o.protocolo}`,user:(t==null?void 0:t.displayName)||(t==null?void 0:t.email)||"Usuário desconhecido"})})}f.success("Remessa iniciada com sucesso!"),b("/remessas")}catch(a){console.error("Erro ao iniciar remessa:",a),f.error("Ocorreu um erro ao iniciar a remessa.")}finally{m(!1)}};return e.jsxs("div",{className:"w-full min-h-screen p-4 space-y-6",children:[e.jsx(W,{}),e.jsx(X,{children:e.jsxs(Z,{children:[e.jsx(w,{children:e.jsx(q,{href:"/",children:"Dashboard"})}),e.jsx(B,{}),e.jsx(w,{children:e.jsx(q,{href:"/remessas",children:"Lista de Remessas"})}),e.jsx(B,{}),e.jsx(w,{children:e.jsx(U,{children:"Nova Remessa"})})]})}),e.jsx("div",{className:"flex justify-between items-center",children:e.jsx("h1",{className:"text-2xl font-bold",children:"Iniciar Nova Remessa"})}),c?e.jsx("p",{children:"Carregando..."}):e.jsx(e.Fragment,{children:n.length===0?e.jsx("p",{children:"Nenhum cheque disponível no escritório."}):e.jsxs("div",{children:[e.jsx("div",{className:"rounded-md border",children:e.jsxs(ge,{children:[e.jsx(xe,{children:l.getHeaderGroups().map(a=>e.jsx(y,{children:a.headers.map(s=>e.jsx(pe,{children:s.isPlaceholder?null:k(s.column.columnDef.header,s.getContext())},s.id))},a.id))}),e.jsx(fe,{children:(P=l.getRowModel().rows)!=null&&P.length?l.getRowModel().rows.map(a=>e.jsx(y,{"data-state":a.getIsSelected()&&"selected",onClick:()=>a.toggleSelected(),className:a.getIsSelected()?"bg-gray-100":"",children:a.getVisibleCells().map(s=>e.jsx(I,{children:k(s.column.columnDef.cell,s.getContext())},s.id))},a.id)):e.jsx(y,{children:e.jsx(I,{colSpan:S.length,className:"h-24 text-center",children:"Nenhum cheque encontrado."})})})]})}),e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx(E,{children:e.jsxs($,{children:[e.jsx(j,{children:e.jsx(A,{href:"#",onClick:()=>l.previousPage()})}),Array.from({length:l.getPageCount()}).map((a,s)=>e.jsx(j,{children:e.jsx(R,{href:"#",onClick:()=>l.setPageIndex(s),children:s+1})},s)),e.jsx(j,{children:e.jsx(V,{href:"#",onClick:()=>l.nextPage()})})]})})}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx(ee,{onClick:Y,disabled:c,children:c?"Iniciando...":`Iniciar Remessa com ${p.length} Cheque(s)`})})]})})]})};export{ve as default};

import{r as n,i as V,X as F,j as e,B as K,d as y,e as p,f as H,T as C,a0 as Y,ab as q,a8 as O,ac as z,q as Q,t as X,v as _,w as G}from"./index-1L3QXtjl.js";import{Q as J,B as u}from"./ReactToastify-CoRJ3_DZ.js";import{u as W,f as B,g as Z,a as U,b as ee,c as ae}from"./index-CROdxjaZ.js";import{T as se,a as oe,b as x,c as te,d as ce,e as v}from"./table-BI1FEwuE.js";import{C as N}from"./checkbox-Dr7Q6U16.js";import{E as re,a as ne}from"./jspdf.plugin.autotable-hZhhW0S0.js";import{B as le,a as ie,b as f,c as D,d as L,e as de}from"./breadcrumb-DSX5xbwg.js";import"./check-7Du4jFlM.js";import"./chevron-right-DkwqzOMG.js";const je=()=>{var w;const[R,T]=n.useState([]),[g,m]=n.useState(!0),[h,P]=n.useState([]),[b,M]=n.useState({}),I=V(),{currentUser:t}=F();n.useEffect(()=>{(async()=>{m(!0);try{const s=y(p,"cheques"),r=(await H(s)).docs.map(c=>({...c.data(),id:c.id})).filter(c=>c.local==="Escritório");T(r)}catch(s){console.error("Erro ao buscar cheques:",s),u.error("Ocorreu um erro ao buscar os cheques.")}finally{m(!1)}})()},[]);const j=[{id:"select",header:({table:a})=>e.jsx(N,{checked:a.getIsAllPageRowsSelected(),onCheckedChange:s=>a.toggleAllPageRowsSelected(!!s),"aria-label":"Selecionar todos"}),cell:({row:a})=>e.jsx(N,{checked:a.getIsSelected(),onCheckedChange:s=>a.toggleSelected(!!s),"aria-label":"Selecionar linha"}),enableSorting:!1,enableHiding:!1},{accessorKey:"numeroCheque",header:"Número do Cheque"},{accessorKey:"banco",header:"Banco"},{accessorKey:"vencimento",header:"Vencimento",cell:({row:a})=>{const s=a.getValue("vencimento");return new Date(s).toLocaleDateString("pt-BR")}},{accessorKey:"nome",header:"Nome"},{accessorKey:"valor",header:()=>e.jsx("div",{className:"text-right",children:"Valor"}),cell:({row:a})=>{const o=a.getValue("valor").toLocaleString("pt-BR",{style:"currency",currency:"BRL"});return e.jsx("div",{className:"text-right font-medium",children:o})}}],l=W({data:R,columns:j,state:{rowSelection:b},onRowSelectionChange:M,getCoreRowModel:Z(),getSortedRowModel:U(),getFilteredRowModel:ee(),getPaginationRowModel:ae()});n.useEffect(()=>{const a=l.getSelectedRowModel().rows.map(s=>s.original);P(a)},[b,l]);const E=()=>{const a=new Date().toLocaleDateString("pt-BR").replace(/\//g,""),s=Math.floor(1e3+Math.random()*9e3).toString();return`${a}${s}`},$=async(a,s)=>{const o=new re;o.setFontSize(18),o.text("Remessa de Cheques",14,22),o.setFontSize(12),o.text(`Protocolo: ${a.protocolo}`,14,32),o.text(`Data da Remessa: ${new Date(a.dataRemessa).toLocaleDateString("pt-BR")}`,14,38),o.text(`Emitido por: ${a.emitidoPor}`,14,44);const r=a.cheques.map((d,A)=>[A+1,d.numeroCheque,d.banco,new Date(d.vencimento).toLocaleDateString("pt-BR"),d.nome,d.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})]);ne(o,{startY:50,head:[["#","Número do Cheque","Banco","Vencimento","Nome","Valor"]],body:r}),o.text("Assinatura de Recebimento:",14,o.lastAutoTable.finalY+30),o.line(14,o.lastAutoTable.finalY+45,196,o.lastAutoTable.finalY+45);const c=o.output("blob"),i=Q(X,`remessas/${s}/Remessa_${a.protocolo}.pdf`);return await _(i,c),await G(i)},k=async()=>{if(m(!0),h.length===0){u.error("Selecione pelo menos um cheque para iniciar a remessa.");return}try{const a=E(),s=y(p,"remessas"),o={protocolo:a,dataRemessa:new Date().toISOString(),emitidoPor:t==null?void 0:t.displayName,cheques:h,status:"Transporte",log:[{timestamp:C.now(),message:"Remessa criada",user:(t==null?void 0:t.displayName)||(t==null?void 0:t.email)||"Usuário desconhecido"}]},r=await Y(s,o),c=await $(o,r.id);await q(r,{documentoPdfUrl:c});for(const i of h){const S=O(p,"cheques",i.id);await q(S,{local:"Transporte",remessaId:r.id,log:z({timestamp:C.now(),message:`Cheque incluído na remessa ${o.protocolo}`,user:(t==null?void 0:t.displayName)||(t==null?void 0:t.email)||"Usuário desconhecido"})})}u.success("Remessa iniciada com sucesso!"),I("/remessas")}catch(a){console.error("Erro ao iniciar remessa:",a),u.error("Ocorreu um erro ao iniciar a remessa.")}finally{m(!1)}};return e.jsxs("div",{className:"w-full min-h-screen p-4 space-y-6",children:[e.jsx(J,{}),e.jsx(le,{children:e.jsxs(ie,{children:[e.jsx(f,{children:e.jsx(D,{href:"/",children:"Dashboard"})}),e.jsx(L,{}),e.jsx(f,{children:e.jsx(D,{href:"/remessas",children:"Lista de Remessas"})}),e.jsx(L,{}),e.jsx(f,{children:e.jsx(de,{children:"Nova Remessa"})})]})}),e.jsx("div",{className:"flex justify-between items-center",children:e.jsx("h1",{className:"text-2xl font-bold ",children:"Iniciar Nova Remessa"})}),g?e.jsx("p",{children:"Carregando..."}):e.jsx(e.Fragment,{children:R.length===0?e.jsx("p",{children:"Nenhum cheque disponível no escritório."}):e.jsxs("div",{children:[e.jsx("div",{className:"rounded-md border",children:e.jsxs(se,{children:[e.jsx(oe,{children:l.getHeaderGroups().map(a=>e.jsx(x,{children:a.headers.map(s=>e.jsx(te,{children:s.isPlaceholder?null:B(s.column.columnDef.header,s.getContext())},s.id))},a.id))}),e.jsx(ce,{children:(w=l.getRowModel().rows)!=null&&w.length?l.getRowModel().rows.map(a=>e.jsx(x,{"data-state":a.getIsSelected()&&"selected",onClick:()=>a.toggleSelected(),className:a.getIsSelected()?"bg-gray-100":"",children:a.getVisibleCells().map(s=>e.jsx(v,{children:B(s.column.columnDef.cell,s.getContext())},s.id))},a.id)):e.jsx(x,{children:e.jsx(v,{colSpan:j.length,className:"h-24 text-center",children:"Nenhum cheque encontrado."})})})]})}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx(K,{onClick:k,disabled:g,children:g?"Iniciando...":`Iniciar Remessa com ${h.length} Cheque(s)`})})]})})]})};export{je as default};
